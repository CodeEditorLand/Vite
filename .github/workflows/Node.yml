name: Node

concurrency:
    group: Node-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    security-events: write
    contents: write
    pull-requests: write

on:
    workflow_dispatch:
    push:
        branches: [Current]
    pull_request:
        branches: [Current]
    workflow_call:

jobs:
    Pre-Publish:
        runs-on: ubuntu-latest

        env:
            ADBLOCK: true
            ASTRO_TELEMETRY_DISABLED: 1
            AUTOMATEDLAB_TELEMETRY_OPTOUT: 1
            AZURE_CORE_COLLECT_TELEMETRY: 0
            CHOOSENIM_NO_ANALYTICS: 1
            DIEZ_DO_NOT_TRACK: 1
            DOTNET_CLI_TELEMETRY_OPTOUT: 1
            DOTNET_INTERACTIVE_CLI_TELEMETRY_OPTOUT: 1
            DO_NOT_TRACK: 1
            ET_NO_TELEMETRY: 1
            GATSBY_TELEMETRY_DISABLED: 1
            GATSBY_TELEMETRY_OPTOUT: 1
            GATSBY_TELEMETRY_OPT_OUT: 1
            GRIT_TELEMETRY_DISABLED: 1
            HASURA_GRAPHQL_ENABLE_TELEMETRY: false
            HINT_TELEMETRY: off
            HOMEBREW_NO_ANALYTICS: 1
            INFLUXD_REPORTING_DISABLED: true
            ITERATIVE_DO_NOT_TRACK: 1
            NEXT_TELEMETRY_DEBUG: 1
            NEXT_TELEMETRY_DISABLED: 1
            NG_CLI_ANALYTICS: false
            NUXT_TELEMETRY_DISABLED: 1
            PIN_DO_NOT_TRACK: 1
            POWERSHELL_TELEMETRY_OPTOUT: 1
            SAM_CLI_TELEMETRY: 0
            STNOUPGRADE: 1
            STRIPE_CLI_TELEMETRY_OPTOUT: 1
            TELEMETRY_DISABLED: 1
            TERRAFORM_TELEMETRY: 0
            VCPKG_DISABLE_METRICS: 1

        strategy:
            matrix:
                node-version: [18, 19, 20]

        steps:
            - uses: actions/checkout@v4.2.1

            - uses: pnpm/action-setup@v4.0.0
              with:
                  version: 9.3.0
                  run_install: |
                      - recursive: true
                        args: [
                          --link-workspace-packages=true,
                          --lockfile-only,
                          --prefer-frozen-lockfile=false,
                          --shamefully-hoist=false,
                          --shared-workspace-lockfile=true,
                          --strict-peer-dependencies=false,
                          --unsafe-perm=true
                        ]

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./docs/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./docs

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./pnpm-lock.yaml

            - run: pnpm install
              working-directory: .

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-Node-${{ matrix.node-version }}-Target
                  path: ./Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/Target

            - run: pnpm run prepublishOnly
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-lit-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-lit-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-lit-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-lit-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-lit/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-lit

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-lit-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-lit/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-preact-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-preact-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-preact-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-preact-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-preact/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-preact

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-preact-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-preact/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-qwik-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-qwik-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-qwik-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-qwik-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-qwik/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-qwik

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-qwik-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-qwik/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-react-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-react-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-react-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-react-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-react/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-react

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-react-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-react/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-solid-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-solid-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-solid-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-solid-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-solid/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-solid

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-solid-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-solid/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-svelte-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-svelte-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-svelte-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-svelte-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-svelte/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-svelte

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-svelte-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-svelte/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-vanilla-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-vanilla-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-vanilla-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-vanilla-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-vanilla/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-vanilla

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-vanilla-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-vanilla/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-vue-ts/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-vue-ts

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-vue-ts-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-vue-ts/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/create-vite/template-vue/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/create-vite/template-vue

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-create-vite-template-vue-Node-${{ matrix.node-version }}-Target
                  path: ./packages/create-vite/template-vue/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/plugin-legacy/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/plugin-legacy

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-plugin-legacy-Node-${{ matrix.node-version }}-Target
                  path: ./packages/plugin-legacy/Target

            - run: pnpm run prepublishOnly
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-plugin-legacy-Node-${{ matrix.node-version }}-Target
                  path: ./packages/plugin-legacy/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./packages/vite/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./packages/vite

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-vite-Node-${{ matrix.node-version }}-Target
                  path: ./packages/vite/Target

            - run: pnpm run prepublishOnly
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-packages-vite-Node-${{ matrix.node-version }}-Target
                  path: ./packages/vite/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/alias/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/alias

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-alias-Node-${{ matrix.node-version }}-Target
                  path: ./playground/alias/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-assets-sanitize-Node-${{ matrix.node-version }}-Target
                  path: ./playground/assets-sanitize/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-assets-Node-${{ matrix.node-version }}-Target
                  path: ./playground/assets/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/backend-integration/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/backend-integration

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-backend-integration-Node-${{ matrix.node-version }}-Target
                  path: ./playground/backend-integration/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-build-old-Node-${{ matrix.node-version }}-Target
                  path: ./playground/build-old/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/cli-module/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/cli-module

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-cli-module-Node-${{ matrix.node-version }}-Target
                  path: ./playground/cli-module/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-cli-Node-${{ matrix.node-version }}-Target
                  path: ./playground/cli/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/config/packages/entry/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/config/packages/entry

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/config/packages/siblings/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/config/packages/siblings

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-csp-Node-${{ matrix.node-version }}-Target
                  path: ./playground/csp/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-codesplit-cjs-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css-codesplit-cjs/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-codesplit-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css-codesplit/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css-lightningcss-proxy/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css-lightningcss-proxy

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css-lightningcss/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css-lightningcss

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-lightningcss-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css-lightningcss/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-no-codesplit-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css-no-codesplit/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css-sourcemap/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css-sourcemap

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-sourcemap-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css-sourcemap/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css/css-proxy-dep/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css/css-proxy-dep

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-postcss-caching-blue-app-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css/postcss-caching/blue-app/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-css-postcss-caching-green-app-Node-${{ matrix.node-version }}-Target
                  path: ./playground/css/postcss-caching/green-app/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/css/scss-proxy-dep/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/css/scss-proxy-dep

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-data-uri-Node-${{ matrix.node-version }}-Target
                  path: ./playground/data-uri/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/define/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/define

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-define-Node-${{ matrix.node-version }}-Target
                  path: ./playground/define/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-dynamic-import-inline-Node-${{ matrix.node-version }}-Target
                  path: ./playground/dynamic-import-inline/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/dynamic-import/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/dynamic-import

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-dynamic-import-Node-${{ matrix.node-version }}-Target
                  path: ./playground/dynamic-import/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-env-nested-Node-${{ matrix.node-version }}-Target
                  path: ./playground/env-nested/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-env-Node-${{ matrix.node-version }}-Target
                  path: ./playground/env/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/extensions/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/extensions

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-extensions-Node-${{ matrix.node-version }}-Target
                  path: ./playground/extensions/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/external/dep-that-imports/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/external/dep-that-imports

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/external/dep-that-requires/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/external/dep-that-requires

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/external/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/external

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-external-Node-${{ matrix.node-version }}-Target
                  path: ./playground/external/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-fs-serve-Node-${{ matrix.node-version }}-Target
                  path: ./playground/fs-serve/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/glob-import/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/glob-import

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-glob-import-Node-${{ matrix.node-version }}-Target
                  path: ./playground/glob-import/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-hmr-ssr-Node-${{ matrix.node-version }}-Target
                  path: ./playground/hmr-ssr/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-hmr-Node-${{ matrix.node-version }}-Target
                  path: ./playground/hmr/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-html-Node-${{ matrix.node-version }}-Target
                  path: ./playground/html/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/import-assertion/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/import-assertion

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-import-assertion-Node-${{ matrix.node-version }}-Target
                  path: ./playground/import-assertion/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/js-sourcemap/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/js-sourcemap

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-js-sourcemap-Node-${{ matrix.node-version }}-Target
                  path: ./playground/js-sourcemap/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/json/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/json

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-json-Node-${{ matrix.node-version }}-Target
                  path: ./playground/json/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/legacy/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/legacy

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-legacy-Node-${{ matrix.node-version }}-Target
                  path: ./playground/legacy/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/lib/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/lib

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-lib-Node-${{ matrix.node-version }}-Target
                  path: ./playground/lib/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/minify/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/minify

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-minify-Node-${{ matrix.node-version }}-Target
                  path: ./playground/minify/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-module-graph-Node-${{ matrix.node-version }}-Target
                  path: ./playground/module-graph/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/multiple-entrypoints/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/multiple-entrypoints

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-multiple-entrypoints-Node-${{ matrix.node-version }}-Target
                  path: ./playground/multiple-entrypoints/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/nested-deps/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/nested-deps

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-nested-deps-Node-${{ matrix.node-version }}-Target
                  path: ./playground/nested-deps/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/nested-deps/test-package-d/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/nested-deps/test-package-d

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/nested-deps/test-package-e/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/nested-deps/test-package-e

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/nested-deps/test-package-e/test-package-e-included/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/nested-deps/test-package-e/test-package-e-included

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/object-hooks/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/object-hooks

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-object-hooks-Node-${{ matrix.node-version }}-Target
                  path: ./playground/object-hooks/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps-no-discovery/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps-no-discovery

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-optimize-deps-no-discovery-Node-${{ matrix.node-version }}-Target
                  path: ./playground/optimize-deps-no-discovery/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/dep-alias-using-absolute-path/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/dep-alias-using-absolute-path

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/dep-linked-include/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/dep-linked-include

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/dep-linked/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/dep-linked

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/dep-with-optional-peer-dep-submodule/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/dep-with-optional-peer-dep-submodule

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/dep-with-optional-peer-dep/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/dep-with-optional-peer-dep

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/nested-exclude/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps/nested-exclude

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-deps/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-deps

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-optimize-deps-Node-${{ matrix.node-version }}-Target
                  path: ./playground/optimize-deps/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-missing-deps/missing-dep/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-missing-deps/missing-dep

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/optimize-missing-deps/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/optimize-missing-deps

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/preload/dep-including-a/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/preload/dep-including-a

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/preload/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/preload

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-preload-Node-${{ matrix.node-version }}-Target
                  path: ./playground/preload/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/preserve-symlinks/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/preserve-symlinks

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-preserve-symlinks-Node-${{ matrix.node-version }}-Target
                  path: ./playground/preserve-symlinks/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-proxy-bypass-Node-${{ matrix.node-version }}-Target
                  path: ./playground/proxy-bypass/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-proxy-hmr-other-app-Node-${{ matrix.node-version }}-Target
                  path: ./playground/proxy-hmr/other-app/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-proxy-hmr-Node-${{ matrix.node-version }}-Target
                  path: ./playground/proxy-hmr/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-resolve-config-Node-${{ matrix.node-version }}-Target
                  path: ./playground/resolve-config/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/resolve/browser-field/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/resolve/browser-field

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/resolve/exports-with-module-condition-required/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/resolve/exports-with-module-condition-required

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/resolve/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/resolve

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-resolve-Node-${{ matrix.node-version }}-Target
                  path: ./playground/resolve/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/resolve/require-pkg-with-module-field/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/resolve/require-pkg-with-module-field

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/resolve/sharp-dir/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/resolve/sharp-dir

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-alias/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-alias

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-ssr-alias-Node-${{ matrix.node-version }}-Target
                  path: ./playground/ssr-alias/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-conditions/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-conditions

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/external-using-external-entry/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps/external-using-external-entry

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/forwarded-export/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps/forwarded-export

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/non-optimized-with-nested-external/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps/non-optimized-with-nested-external

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/optimized-cjs-with-nested-external/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps/optimized-cjs-with-nested-external

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/optimized-with-nested-external/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps/optimized-with-nested-external

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-deps/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-deps

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-html/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-html

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-noexternal/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-noexternal

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-ssr-noexternal-Node-${{ matrix.node-version }}-Target
                  path: ./playground/ssr-noexternal/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-noexternal/require-external-cjs/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-noexternal/require-external-cjs

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-pug/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-pug

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-resolve/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-resolve

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-ssr-resolve-Node-${{ matrix.node-version }}-Target
                  path: ./playground/ssr-resolve/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr-webworker/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr-webworker

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/ssr/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/ssr

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/tailwind-sourcemap/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/tailwind-sourcemap

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-tailwind-sourcemap-Node-${{ matrix.node-version }}-Target
                  path: ./playground/tailwind-sourcemap/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/tailwind/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/tailwind

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-tailwind-Node-${{ matrix.node-version }}-Target
                  path: ./playground/tailwind/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-transform-plugin-Node-${{ matrix.node-version }}-Target
                  path: ./playground/transform-plugin/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-tsconfig-json-load-error-Node-${{ matrix.node-version }}-Target
                  path: ./playground/tsconfig-json-load-error/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-tsconfig-json-Node-${{ matrix.node-version }}-Target
                  path: ./playground/tsconfig-json/Target

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-wasm-Node-${{ matrix.node-version }}-Target
                  path: ./playground/wasm/Target

            - uses: actions/setup-node@v4.0.4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./playground/worker/pnpm-lock.yaml

            - run: pnpm install
              working-directory: ./playground/worker

            - run: pnpm run build
              working-directory: .

            - uses: actions/upload-artifact@v4.4.0
              with:
                  name: .-playground-worker-Node-${{ matrix.node-version }}-Target
                  path: ./playground/worker/Target
